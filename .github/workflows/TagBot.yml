name: TagBot
on:
  issue_comment:
    types:
      - created
  workflow_dispatch:
jobs:
  TagBot:
    if: github.event_name == 'workflow_dispatch' || github.actor == 'JuliaTagBot' || github.actor == 'AntonOresten'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Create releases
        run: |
          # Get package info from registry
          REPO="${{ github.repository }}"
          REGISTRY="MurrellGroup/MurrellGroupRegistry"
          PKG_NAME=$(basename "$REPO" .jl)

          # Find package in registry and get all registered versions
          VERSIONS_TOML=$(gh api "repos/$REGISTRY/contents/$( \
            gh api "repos/$REGISTRY/contents/Registry.toml" --jq '.content' | \
            base64 -d | grep -A1 "\"$PKG_NAME\"" | grep path | sed 's/.*= "\(.*\)"/\1/' \
          )/Versions.toml" --jq '.content' | base64 -d)

          # Create releases for any version that doesn't have one yet
          for VERSION in $(echo "$VERSIONS_TOML" | grep '^\[' | tr -d '[]"'); do
            TAG="v$VERSION"
            if ! gh release view "$TAG" --repo "$REPO" &>/dev/null; then
              echo "Creating release $TAG"
              gh release create "$TAG" --repo "$REPO" --generate-notes || true
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.TAGBOT_PAT }}
